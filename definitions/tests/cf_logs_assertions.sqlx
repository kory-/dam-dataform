config {
  type: "assertion",
  schema: "dam_workflow_test",
  name: "cf_logs_assertions",
  tags: ["test", "quality"]
}

-- Dataform assertions should return 0 rows when successful
WITH test_results AS (
  -- Test 1: No NULL values in critical fields
  SELECT 
    "cf_logs_null_check" AS test_name,
    COUNT(*) AS failure_count
  FROM `${dataform.projectConfig.defaultDatabase}.${dataform.projectConfig.defaultSchema}.cf_logs`
  WHERE DATE(date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND (
      date IS NULL
      OR c_ip IS NULL
      OR cs_uri_stem IS NULL
      OR sc_status IS NULL
    )

  UNION ALL

  -- Test 2: No duplicate records
  SELECT 
    "cf_logs_duplicates" AS test_name,
    COUNT(*) AS failure_count
  FROM (
    SELECT 
      date,
      c_ip,
      x_edge_request_id,
      COUNT(*) AS dup_count
    FROM `${dataform.projectConfig.defaultDatabase}.${dataform.projectConfig.defaultSchema}.cf_logs`
    WHERE DATE(date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    GROUP BY date, c_ip, x_edge_request_id
    HAVING COUNT(*) > 1
  )

  UNION ALL

  -- Test 3: Valid HTTP status codes
  SELECT 
    "cf_logs_invalid_status" AS test_name,
    COUNT(*) AS failure_count
  FROM `${dataform.projectConfig.defaultDatabase}.${dataform.projectConfig.defaultSchema}.cf_logs`
  WHERE DATE(date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND (sc_status < 100 OR sc_status > 599)

  UNION ALL

  -- Test 4: Valid IP addresses
  SELECT 
    "cf_logs_invalid_ip" AS test_name,
    COUNT(*) AS failure_count
  FROM `${dataform.projectConfig.defaultDatabase}.${dataform.projectConfig.defaultSchema}.cf_logs`
  WHERE DATE(date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND NOT REGEXP_CONTAINS(c_ip, r'^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$|^(?:[0-9a-fA-F]{0,4}:){7}[0-9a-fA-F]{0,4}$')

  UNION ALL

  -- Test 5: Reasonable time values
  SELECT 
    "cf_logs_invalid_time" AS test_name,
    COUNT(*) AS failure_count
  FROM `${dataform.projectConfig.defaultDatabase}.${dataform.projectConfig.defaultSchema}.cf_logs`
  WHERE DATE(date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
    AND time_taken < 0

  UNION ALL

  -- Test 6: Data freshness check
  SELECT 
    "cf_logs_data_freshness" AS test_name,
    1 AS failure_count
  FROM (SELECT 1)
  WHERE NOT EXISTS (
    SELECT 1 
    FROM `${dataform.projectConfig.defaultDatabase}.${dataform.projectConfig.defaultSchema}.cf_logs`
    WHERE DATE(date) = DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
  )
)
-- Only return failed tests (failure_count > 0)
SELECT * FROM test_results WHERE failure_count > 0